<!doctype html>
<html>
    <head>
        <title>Everything</title>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <style type="text/css">
            /* basic table styling from bootstrap */
            * {
                padding: 0;
                margin: 0;
            }
            body {
                font-size: 14px;
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
                color: #222;
            }
            tr {
                border-top: 1px solid #eee;
            }
            td a {
                text-decoration: none;
                color: black;
            }
            thead {
                color: white;
                background-color: black;
            }
            thead tr {
                border: none;
                line-height: 36px;
            }
            table {
              max-width: 100%;
              background-color: transparent;
              border-collapse: collapse;
              border-spacing: 0;
            }
            .table {
              width: 100%;
              margin-bottom: 20px;
            }
            .table th,
            .table td {
              padding: 5px;
              line-height: 15px;
              text-align: left;
              vertical-align: top;
            }
            .table th {
              font-weight: bold;
              line-height: 30px;
            }
            .table thead th {
              vertical-align: bottom;
            }
            .table tbody tr.success {
              background-color: #A6D96A;
            }
            .table tbody tr.error {
              background-color: #FF0000;
              border-top: 1px solid black;
              border-bottom: 1px solid black;
            }

            #controls {
                bottom: 0;
                right: 0;
                background-color: white;
                position: fixed;
                padding: 10px;
                box-shadow: 0 0 50px rgba(0,0,0,0.2);
                line-height: 1.5em;
            }
            input[type='radio'] {
                margin-right: 5px;
            }
        </style>
    </head>
    <body>
        <div id='controls'>
            <input type='radio' name='filter' value='everything' id='everything' checked><label for='everything'>everything</label><br>
            <input type='radio' name='filter' value='red' id='red'><label for='red'>problems (red)</label><br>
            <input type='radio' name='filter' value='green' id='green'><label for='green'>done (green)</label><br>
            <input type='radio' name='filter' value='users' id='users'><label for='users'>user: 
                <select id='user-select'></select></label><br>
            <input type='radio' name='filter' value='problems' id='problems'><label for='problems'>problem: 
                <select id='problem-select'></select></label><br>
        </div>
        <table id='main_table' class='table'>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Problem</th>
                    <th>Done</th>
                    <th>Difficult</th>
                    <th>User</th>
                    <th>Time</th>
                    <th>Mark as done</th>
                    <th>Edit in JOSM</th>
                </tr>
            </thead>
        </table>
        <script type="text/javascript">
        function locate() {
            // absolutely in no way comprehensive
            var location = {};
            if (window.location.search) {
                var search = window.location.search.split('?');
                for (var a = 0; a < search.length; a++) {
                    if (a == search.length-1) {
                        /* remove trailing slash */
                        if (search[a].substr(-1) == '/') {
                            search[a] = search[a].slice(0,-1);
                        }
                    }

                    if (search[a] != '') {
                        var split = search[a].split('=');
                        if (split.length = 2) {
                            location[split[0]] = split[1];
                        }
                    }
                }
            }
            return location;
        }

        function buildTable() {
            // need to check the current state of filters, possibly apply them
            // then buildTable as a callback


            // index from simple.py: id, problem, done, difficult, user, time
            items = window.everything;

            if (document.getElementsByTagName('tbody').length) {
                // clear the way
                var table = document.getElementById('main_table');
                table.removeChild(document.getElementsByTagName('tbody')[0]);
            }

            var table = document.createElement('tbody');

            for (var a = 0; a < items.length; a++) {
                // rows
                var tr = document.createElement('tr');
                for (var b = 0; b < items[a].length; b++) {
                    // columns
                    var column = document.createElement('td'),
                        text = document.createTextNode(items[a][b]);
                    column.appendChild(text);
                    tr.appendChild(column);
                }

                // mark as done
                var column = document.createElement('td');
                if (items[a][2] === 0) {
                    // put a button in there, alert for confirmation
                    // need to pass the id somehow
                    // need to pass the id
                    column.innerHTML = '<a href="" id="' + items[a][0] +'">mark as done?</a>';
                }
                tr.appendChild(column);

                // edit in josm
                var column = document.createElement('td');
                if (items[a][2] === 0) {
                    // put a button in there, use modal for notifying it's ready/failed
                    // need to pass the id
                    column.innerHTML = '<a href="" id="' + items[a][0] +'">edit in JOSM</a>';
                }
                tr.appendChild(column);

                // background-colors
                // careful with the order here, it's not obvious
                // some problems might have been fixed manually yet still have 'problem' in db
                if (items[a][2] === 1) {
                    tr.setAttribute('class', 'success');
                } else if (items[a][1] != '') {
                    tr.setAttribute('class', 'error');
                } else if (items[a][3] === 1) {
                    tr.setAttribute('class', 'error');
                }

                table.appendChild(tr);
                document.getElementById('main_table').appendChild(table);
            }
        }

        function request(query, callback) {
            $.ajax({
                url: query,
                cache: false
            }).done(function(items){
                window.everything = JSON.parse(items);
                if (callback) callback();
            });
        }

        function refresh(callback) {
            request(window.loc['db'] + '&everything', callback)
        }

        function filter(options){
            // {'problem': 1, 'user': 'Joe Fake Name'}
            // also takes values as a list of multiple possible values
                // {'problem': ['no_park', 'bad_imagery', 'you_ugly']}
                // or even better: {'problem': unique('problem')}
            // index from simple.py: id, problem, done, difficult, user, time
            // BE AWARE: this alters window.everything which the table relies on
                // also redrawing the table is a seperate function, buildTable()
            var ndx = {
                'problem': 1,
                'done': 2,
                'difficult': 3,
                'user': 4,
                'time': 5
            }

            var items = window.everything,
                out = [];

            for (var a = 0; a < items.length; a++) {
                var keep = false;
                for (var option in options) {
                    if (typeof options[option] == 'object') {
                        if (options[option].indexOf(items[a][ndx[option]]) !== -1) {
                            keep = true
                        }
                    } else if (items[a][ndx[option]] == options[option]) {
                        keep = true;
                    }
                    if (keep) out.push(items[a]);
                }
            }
            window.everything = out;
        }

        function count(options) {
            // {'done': 1, 'user': 'Joe'}
            var ndx = {
                'problem': 1,
                'done': 2,
                'difficult': 3,
                'user': 4,
                'time': 5
            }

            var items = window.everything,
                out = {};

            for (var option in options) {
                out[option] = 0;
            }

            for (var a = 0; a < items.length; a++) {
                for (var option in options) {
                    if (items[a][ndx[option]] == options[option]) {
                        out[option]++;
                    }
                }
            }

            return out;
        }

        function unique(column) {
            // lists unique values for a given column
            // probably only useful for 'problem' and 'user'
            var ndx = {
                'problem': 1,
                'done': 2,
                'difficult': 3,
                'user': 4,
                'time': 5
            }
            
            var items = window.everything,
                unique = [];

            for (var a = 0; a < items.length; a++) {
                if (items[a][ndx[column]] && unique.indexOf(items[a][ndx[column]]) === -1) {
                    unique.push(items[a][ndx[column]]);
                }
            }

            return unique;
        }

        function problem_selection() {
            var problems = unique('problem'),
                html = '',
                select = document.getElementById('problem-select');

            for (var a = 0; a < problems.length; a++) {
                html += '<option>' + problems[a] + '</option>';
            }

            select.innerHTML = html;
        }

        function user_selection() {
            var problems = unique('user'),
                html = '',
                select = document.getElementById('user-select');

            for (var a = 0; a < problems.length; a++) {
                html += '<option>' + problems[a] + '</option>';
            }

            select.innerHTML = html;
        }


        window.loc = locate()
        if (window.loc['db']) {
            window.loc['db'] = decodeURIComponent(loc['db']);
            refresh(buildTable);
            // filter({
            //     'done': 1
            // });
            // buildTable();
        } else {
            console.log('need a db to load. /?db=');
        }

        </script>
    </body>
</html>
