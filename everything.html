<!doctype html>
<html>
    <head>
        <title>Everything</title>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <style type="text/css">
            /* basic table styling from bootstrap */
            * {
                padding: 0;
                margin: 0;
            }
            body {
                font-size: 14px;
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
                color: #222;
            }
            tr {
                border-top: 1px solid #eee;
            }
            td a {
                text-decoration: none;
                color: black;
            }
            thead {
                color: white;
                background-color: black;
            }
            thead tr {
                border: none;
                line-height: 36px;
            }
            table {
              max-width: 100%;
              background-color: transparent;
              border-collapse: collapse;
              border-spacing: 0;
            }
            .table {
              width: 100%;
              margin-bottom: 20px;
            }
            .table th,
            .table td {
              padding: 5px;
              line-height: 15px;
              text-align: left;
              vertical-align: top;
            }
            .table th {
              font-weight: bold;
              line-height: 30px;
            }
            .table thead th {
              vertical-align: bottom;
            }
            .table tbody tr.success {
              background-color: #00BF00;
            }
            .table tbody tr.error {
              background-color: #FF2626;
              border-top: 1px solid black;
              border-bottom: 1px solid black;
            }

            #controls {
                bottom: 0;
                right: 0;
                background-color: white;
                position: fixed;
                padding: 10px 15px;
                box-shadow: 0 0 10px rgba(0,0,0,0.5);
                line-height: 1.5em;
            }
            input[type='radio'] {
                margin-right: 5px;
            }
            #count {
                right: 20px;
                position: absolute;
                font-weight: bold;
                color: white;
                font-size: 48px;
                text-shadow: 0 0px 10px rgba(0,0,0,0.5);
                top: -40px;
            }
            #count span {
                font-size: 24px;
            }
        </style>
    </head>
    <body>
        <div id='controls'>
            <span id='count'></span>
            <input type='radio' name='filter' value='everything' id='everything' onclick='click_everything()' checked><label for='everything'> everything</label><br>
            <input type='radio' name='filter' value='red' id='red' onclick='click_red()'><label for='red'> problems (red)</label><br>
            <input type='radio' name='filter' value='green' id='green'onclick='click_green()'><label for='green'> done (green)</label><br>
            <input type='radio' name='filter' value='users' id='users' onclick='drop_selection("users-select")'><label for='users'> user: </label>
                <select id='users-select' onchange='drop_selection("users-select")'></select><br>
            <input type='radio' name='filter' value='problems' id='problems' onclick='drop_selection("problems-select")'><label for='problems'> problem: </label>
                <select id='problems-select' onchange='drop_selection("problems-select")'></select><br>
        </div>
        <table id='main_table' class='table'>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Problem</th>
                    <th>Done</th>
                    <th>Difficult</th>
                    <th>User</th>
                    <th>Time</th>
                    <th>Mark as done</th>
                    <th>Edit in JOSM</th>
                </tr>
            </thead>
        </table>
        <script type="text/javascript">
        function locate() {
            // absolutely in no way comprehensive
            var location = {};
            if (window.location.search) {
                var search = window.location.search.split('?');
                for (var a = 0; a < search.length; a++) {
                    if (a == search.length-1) {
                        /* remove trailing slash */
                        if (search[a].substr(-1) == '/') {
                            search[a] = search[a].slice(0,-1);
                        }
                    }

                    if (search[a] != '') {
                        var split = search[a].split('=');
                        if (split.length = 2) {
                            location[split[0]] = split[1];
                        }
                    }
                }
            }
            return location;
        }

        function buildTable() {
            // need to check the current state of filters, possibly apply them
            // then buildTable as a callback


            // index from simple.py: id, problem, done, difficult, user, time
            items = window.everything;

            if (document.getElementsByTagName('tbody').length) {
                // clear the way
                var table = document.getElementById('main_table');
                table.removeChild(document.getElementsByTagName('tbody')[0]);
            }

            var table = document.createElement('tbody');

            for (var a = 0; a < items.length; a++) {
                // rows
                var tr = document.createElement('tr');
                for (var b = 0; b < items[a].length; b++) {
                    // columns
                    var column = document.createElement('td'),
                        text = document.createTextNode(items[a][b]);
                    column.appendChild(text);
                    tr.appendChild(column);
                }

                // mark as done
                var column = document.createElement('td');
                if (items[a][2] === 0) {
                    // put a button in there, alert for confirmation
                    // need to pass the id somehow
                    // need to pass the id
                    column.innerHTML = '<a href="" id="' + items[a][0] +'">mark as done?</a>';
                }
                tr.appendChild(column);

                // edit in josm
                var column = document.createElement('td');
                if (items[a][2] === 0) {
                    // put a button in there, use modal for notifying it's ready/failed
                    // need to pass the id
                    column.innerHTML = '<a href="" id="' + items[a][0] +'">edit in JOSM</a>';
                }
                tr.appendChild(column);

                // background-colors
                // careful with the order here, it's not obvious
                // some problems might have been fixed manually yet still have 'problem' in db
                if (items[a][2] === 1) {
                    tr.setAttribute('class', 'success');
                } else if (items[a][1] != '') {
                    tr.setAttribute('class', 'error');
                } else if (items[a][3] === 1) {
                    tr.setAttribute('class', 'error');
                }

                table.appendChild(tr);
                document.getElementById('main_table').appendChild(table);
            }

            count_current_rows();
        }

        function request(query, callback) {
            $.ajax({
                url: query,
                cache: false
            }).done(function(items){
                window.everything = JSON.parse(items);
                window.everythingRaw = JSON.parse(items);
                // window.everything is the current state of the table
                // window.everythingRaw is the originally fetched data
                if (callback) callback();
            });
        }

        function refresh(callback) {
            request(window.loc['db'] + '&everything', callback)
        }

        function filter(options){
            // {'problem': 1, 'user': 'Joe Fake Name'}
            // also takes values as a list of multiple possible values
                // {'problem': ['no_park', 'bad_imagery', 'you_ugly']}
                // or even better: {'problem': unique('problem')}
            // index from simple.py: id, problem, done, difficult, user, time
            // BE AWARE: this alters window.everything which the table relies on
                // also redrawing the table is a seperate function, buildTable()
            var ndx = {
                'problem': 1,
                'done': 2,
                'difficult': 3,
                'user': 4,
                'time': 5
            }

            var items = window.everythingRaw,
                out = [];

            for (var a = 0; a < items.length; a++) {
                var keep = false;
                for (var option in options) {
                    if (typeof options[option] == 'object') {
                        if (options[option].indexOf(items[a][ndx[option]]) !== -1) {
                            keep = true
                        }
                    } else if (items[a][ndx[option]] == options[option]) {
                        keep = true;
                    }
                    if (keep) out.push(items[a]);
                }
            }
            window.everything = out;
        }

        function count(options) {
            // {'done': 1, 'user': 'Joe'}
            var ndx = {
                'problem': 1,
                'done': 2,
                'difficult': 3,
                'user': 4,
                'time': 5
            }

            var items = window.everything,
                out = {};

            for (var option in options) {
                out[option] = 0;
            }

            for (var a = 0; a < items.length; a++) {
                for (var option in options) {
                    if (items[a][ndx[option]] == options[option]) {
                        out[option]++;
                    }
                }
            }

            return out;
        }

        function unique(column) {
            // lists unique values for a given column
            // probably only useful for 'problem' and 'user'
            var ndx = {
                'problem': 1,
                'done': 2,
                'difficult': 3,
                'user': 4,
                'time': 5
            }
            
            var items = window.everythingRaw,
                unique = [];

            for (var a = 0; a < items.length; a++) {
                if (items[a][ndx[column]] && unique.indexOf(items[a][ndx[column]]) === -1) {
                    unique.push(items[a][ndx[column]]);
                }
            }

            return unique;
        }

        function problem_selection() {
            var problems = unique('problem'),
                html = '',
                select = document.getElementById('problems-select');

            for (var a = 0; a < problems.length; a++) {
                html += '<option value="problem:' + problems[a] + '">' + problems[a] + '</option>';
            }

            select.innerHTML = html;
        }

        function user_selection() {
            var user = unique('user'),
                html = '',
                select = document.getElementById('users-select');

            for (var a = 0; a < user.length; a++) {
                html += '<option value="user:' + user[a] +'">' + user[a] + '</option>';
            }

            select.innerHTML = html;
        }

        function click_everything() {
            window.everything = window.everythingRaw;
            buildTable();
        }

        function click_red() {
            filter({
                'problem': unique('problem'),
                'difficult': 1
            });
            buildTable();
        }

        function click_green() {
            filter({'done': 1});
            buildTable();
        }

        function drop_selection(select) {
            // this is much too involved for what it does
            // gets the value of the changed dropdown menu and filters based on it
            // also selects the parent radio button
            var selector = document.getElementById(select),
                value = selector.options[selector.selectedIndex].value,
                dict = {};
            value = value.split(':');
            dict[value[0]] = value[1];
                // dict is necessary because value = {value[0]: value[1]} didn't work
                    // seems like it should?

            // filter the items, rebuild the table w/ filtered items
            filter(dict);
            buildTable();

            // select the parent radio button
            var parentRadio = select.split('-')[0],
                controls = document.getElementById('controls'),
                radios = controls.getElementsByTagName('input');

            for (var i = 0; i < radios.length; i++) {
                if (radios[i].type === 'radio') {
                    if (radios[i].value == parentRadio) {
                        radios[i].checked = true;
                    } else {
                        radios[i].checked = false;
                    }
                }
            }
        }

        function count_current_rows() {
            var count = document.getElementById('count');

            if (window.everything.length === window.everythingRaw.length) {
                count.innerHTML = window.everything.length;
            } else {
                count.innerHTML = window.everything.length.toString() + '<span>/' + window.everythingRaw.length + '</span>';
            }
        }


        window.loc = locate()
        if (window.loc['db']) {
            window.loc['db'] = decodeURIComponent(loc['db']);
            refresh(function() {
                buildTable();
                problem_selection();
                user_selection();
            });
        } else {
            console.log('need a db to load. /?db=');
        }

        </script>
    </body>
</html>
